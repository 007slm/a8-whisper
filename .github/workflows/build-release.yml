name: Build & Release

on:
  push:
    tags:
      - 'v*'   # release tags
    branches: [main]   # trigger dev pipeline on main pushes
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # -------------------------------------------------
  # 1ï¸âƒ£ Dev build â€“ identical to release but keeps console for debugging
  # -------------------------------------------------
  dev:
    runs-on: windows-latest
    env:
      KMP_DUPLICATE_LIB_OK: TRUE
      HF_ENDPOINT: https://hf-mirror.com
      CI: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install uv
        run: pip install uv

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/uv
            %LOCALAPPDATA%\\uv\\cache
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install Python dependencies (locked)
        run: |
          uv sync
          # Ensure Nuitka/Zstandard are installed (they are in pyproject.toml)
          uv pip install nuitka zstandard

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'gui_web/package-lock.json'

      - name: Cache frontend dependencies
        uses: actions/cache@v4
        with:
          path: gui_web/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('gui_web/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install frontend dependencies
        run: |
          cd gui_web
          npm ci --prefer-offline

      - name: Build frontend
        run: |
          cd gui_web
          npm run build

      - name: Cache frontend build
        uses: actions/cache@v4
        with:
          path: gui_web/dist
          key: ${{ runner.os }}-frontend-${{ hashFiles('gui_web/src/**/*', 'gui_web/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-

      - name: Cache Nuitka CCache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Nuitka
            %LOCALAPPDATA%\\Nuitka\\Nuitka\\Cache
          key: ${{ runner.os }}-nuitka-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-

      - name: Build executable (dev mode â€“ console enabled)
        run: |
          # Kill stray processes
          Get-Process | Where-Object {$_.ProcessName -like "*A8*" -or $_.ProcessName -like "*python*"} | Stop-Process -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2

          # Clean previous builds
          if (Test-Path "dist_nuitka") { Remove-Item -Recurse -Force "dist_nuitka" -ErrorAction SilentlyContinue }

          # Ensure icon exists
          if (-not (Test-Path "src/assets/icon.ico")) {
            uv run python -c "from PIL import Image; img = Image.new('RGB', (256, 256), (99, 102, 241)); img.save('src/assets/icon.ico', format='ICO'); print('Fallback icon.ico created')"
          }

          # Build â€“ keep console for debugging
          .\\build_nuitka.ps1 -SkipFrontend -Clean
        shell: powershell
        timeout-minutes: 90
        env:
          CI: true

      - name: Run basic sanity check (executable starts)
        run: |
          dist_nuitka\\main_webview.dist\\main_webview.exe --version || exit 1
        shell: powershell

      - name: Run pytest (if tests exist)
        run: |
          uv run pytest -q || echo "No tests found"
        shell: powershell

  # -------------------------------------------------
  # 2ï¸âƒ£ Release â€“ identical build but console disabled & packaging
  # -------------------------------------------------
  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: dev
    runs-on: windows-latest
    env:
      KMP_DUPLICATE_LIB_OK: TRUE
      HF_ENDPOINT: https://hf-mirror.com
      CI: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install uv
        run: pip install uv

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/uv
            %LOCALAPPDATA%\\uv\\cache
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install Python dependencies (locked)
        run: |
          uv sync
          uv pip install nuitka zstandard

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'gui_web/package-lock.json'

      - name: Cache frontend dependencies
        uses: actions/cache@v4
        with:
          path: gui_web/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('gui_web/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install frontend dependencies
        run: |
          cd gui_web
          npm ci --prefer-offline

      - name: Build frontend
        run: |
          cd gui_web
          npm run build

      - name: Cache frontend build
        uses: actions/cache@v4
        with:
          path: gui_web/dist
          key: ${{ runner.os }}-frontend-${{ hashFiles('gui_web/src/**/*', 'gui_web/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-

      - name: Cache Nuitka CCache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Nuitka
            %LOCALAPPDATA%\\Nuitka\\Nuitka\\Cache
          key: ${{ runner.os }}-nuitka-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-

      - name: Sync version to pyproject.toml
        run: |
          $ver = Get-Content "VERSION"
          (Get-Content "pyproject.toml") -replace 'version = ".*"', "version = \"$ver\"" | Set-Content "pyproject.toml"
        shell: powershell

      - name: Build executable (release mode â€“ console disabled)
        run: |
          # Kill stray processes
          Get-Process | Where-Object {$_.ProcessName -like "*A8*" -or $_.ProcessName -like "*python*"} | Stop-Process -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2

          if (Test-Path "dist_nuitka") { Remove-Item -Recurse -Force "dist_nuitka" -ErrorAction SilentlyContinue }

          if (-not (Test-Path "src/assets/icon.ico")) {
            uv run python -c "from PIL import Image; img = Image.new('RGB', (256, 256), (99, 102, 241)); img.save('src/assets/icon.ico', format='ICO'); print('Fallback icon.ico created')"
          }

          .\\build_nuitka.ps1 -SkipFrontend -Clean
        shell: powershell
        timeout-minutes: 90
        env:
          CI: true

      - name: Verify executable starts (no console)
        run: |
          dist_nuitka\\main_webview.dist\\main_webview.exe --version || exit 1
        shell: powershell

      - name: Create release package
        run: |
          $version = "${{ github.ref_name }}"
          $releaseName = "A8Whisper-$version"

          New-Item -ItemType Directory -Force -Path "release"

          $nuitkaDist = "dist_nuitka/main_webview.dist"
          if (-not (Test-Path $nuitkaDist)) { Write-Host "ERROR: Nuitka output missing"; exit 1 }

          Copy-Item -Recurse -Path "$nuitkaDist/*" -Destination "release/"

          $exePath = Join-Path "release" "main_webview.exe"
          $newExePath = Join-Path "release" "A8Whisper.exe"
          if (Test-Path $exePath) { Rename-Item -Path $exePath -NewName "A8Whisper.exe" } else { Write-Host "ERROR: main_webview.exe not found"; exit 1 }

          $modelsDir = Join-Path "release" "models"
          if (-not (Test-Path $modelsDir)) { New-Item -ItemType Directory -Force -Path $modelsDir | Out-Null }

          $readmeContent = "# A8 Whisper $version - User Guide`n`n## Quick Start`n1. Doubleâ€‘click A8Whisper.exe to launch`n2. First run will download AI models (â‰ˆ3â€¯GB)`n3. Use Ctrl+Win hotkey to start voice input`n`n## System Requirements`n- Windowsâ€¯10/11 (64â€‘bit)`n- NVIDIA GPU (GTXâ€¯1060 or higher)`n- 8â€¯GB RAM (16â€¯GB recommended)`n- Stable internet connection`n`n## Project Homepage`nhttps://github.com/007slm/a8-whisper`n`n## Bug Reports`nhttps://github.com/007slm/a8-whisper/issues`n`n---`nA8 Whisper â€“ openâ€‘source AI voice assistant"
          [System.IO.File]::WriteAllText("release/README.txt", $readmeContent, [System.Text.Encoding]::UTF8)

          Compress-Archive -Path "release/*" -DestinationPath "$releaseName.zip"
          Get-Item "$releaseName.zip" | Select-Object Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB,2)}}
        shell: powershell

      - name: Upload Release Asset
        uses: actions/upload-artifact@v4
        with:
          name: A8Whisper-${{ github.ref_name }}
          path: A8Whisper-${{ github.ref_name }}.zip

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: A8Whisper-${{ github.ref_name }}.zip
          name: A8 è½»è¯­ ${{ github.ref_name }}
          body: |
            ## ğŸ‰ A8 è½»è¯­ ${{ github.ref_name }}

            **æœ¬ç‰ˆæœ¬ä½¿ç”¨ Nuitka ç¼–è¯‘ï¼Œç¨³å®šæ€§å’Œæ€§èƒ½æ›´ä½³ã€‚**

            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            1. ä¸‹è½½ `A8Whisper-${{ github.ref_name }}.zip`
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. åŒå‡» `A8Whisper.exe` å¯åŠ¨
            4. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½ AI æ¨¡å‹

            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - Windows 10/11 (64ä½)
            - NVIDIA æ˜¾å¡ (GTX 1060 æˆ–æ›´é«˜)
            - 8GB å†…å­˜ (æ¨è 16GB+)
            - 10GB+ å¯ç”¨å­˜å‚¨ç©ºé—´

            ### ğŸ¯ ä½¿ç”¨æ–¹æ³•
            - æŒ‰ä½ `Ctrl + Win` å¼€å§‹å½•éŸ³
            - æ¾å¼€æŒ‰é”®è‡ªåŠ¨è¯†åˆ«å¹¶è¾“å…¥æ–‡å­—

            ### ğŸ”— é¡¹ç›®ä¸»é¡µ
            https://github.com/007slm/a8-whisper

            ### ğŸ› é—®é¢˜åé¦ˆ
            https://github.com/007slm/a8-whisper/issues

            ---
            **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/007slm/a8-whisper/releases
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
