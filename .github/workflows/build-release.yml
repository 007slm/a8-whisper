name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10' 
        cache: 'pip'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'gui_web/package-lock.json'
        
    - name: Install uv
      run: pip install uv
      
    - name: Cache uv dependencies
      uses: actions/cache@v4
      with:
        path: |
          .venv
          ~/.cache/uv
          %LOCALAPPDATA%\uv\cache
        key: ${{ runner.os }}-uv-python${{ matrix.python-version || '3.10' }}-${{ hashFiles('uv.lock', 'pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-python${{ matrix.python-version || '3.10' }}-
          ${{ runner.os }}-uv-
      
    - name: Install Python dependencies
      run: |
        uv sync
        # Nuitka and Zstandard are now in pyproject.toml, so uv sync handles them.
        # Ensure Nuitka is installed (just in case)
        uv pip install nuitka zstandard
      
    - name: Cache frontend dependencies
      uses: actions/cache@v4
      with:
        path: gui_web/node_modules
        key: ${{ runner.os }}-npm-${{ hashFiles('gui_web/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-
      
    - name: Install frontend dependencies
      run: |
        cd gui_web
        npm ci --prefer-offline
        
    - name: Build frontend
      run: |
        cd gui_web
        npm run build
        
    - name: Cache frontend build
      uses: actions/cache@v4
      with:
        path: gui_web/dist
        key: ${{ runner.os }}-frontend-${{ hashFiles('gui_web/src/**/*', 'gui_web/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-frontend-

    - name: Build executable with Nuitka
      run: |
        # Kill any processes
        Get-Process | Where-Object {$_.ProcessName -like "*A8*" -or $_.ProcessName -like "*python*"} | Stop-Process -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 2
        
        # Clean previous builds
        if (Test-Path "dist_nuitka") { Remove-Item -Recurse -Force "dist_nuitka" -ErrorAction SilentlyContinue }
        
        # Create Icon if not exists
        if (-not (Test-Path "src/assets/icon.ico")) {
           uv run python -c "from PIL import Image; img = Image.new('RGB', (256, 256), (99, 102, 241)); img.save('src/assets/icon.ico', format='ICO'); print('Fallback icon.ico created')"
        }
        
        # Run Nuitka Build Script
        .\build_nuitka.ps1 -SkipFrontend -Clean
      shell: powershell
      
    - name: Create release package
      run: |
        $version = "${{ github.ref_name }}"
        $releaseName = "A8Whisper-$version"
        
        # Create release directory
        New-Item -ItemType Directory -Force -Path "release"
        
        # Check Output
        $nuitkaDist = "dist_nuitka/main_webview.dist"
        if (-not (Test-Path $nuitkaDist)) {
             Write-Host "ERROR: Nuitka output directory not found at $nuitkaDist"
             exit 1
        }
        
        # Copy content
        Copy-Item -Recurse -Path "$nuitkaDist/*" -Destination "release/"
        
        # Rename EXE
        $exePath = Join-Path "release" "main_webview.exe"
        $newExePath = Join-Path "release" "A8Whisper.exe"
        if (Test-Path $exePath) {
             Rename-Item -Path $exePath -NewName "A8Whisper.exe"
        } else {
             Write-Host "ERROR: main_webview.exe not found in release folder"
             exit 1
        }
        
        # Create empty models folder
        $modelsDir = Join-Path "release" "models"
        if (-not (Test-Path $modelsDir)) {
             New-Item -ItemType Directory -Force -Path $modelsDir | Out-Null
        }
        
        # Create User Guide
        $readmeContent = "# A8 Whisper $version - User Guide`n`n## Quick Start`n1. Double-click A8Whisper.exe to launch`n2. First run will download AI models (about 3GB)`n3. Use Ctrl + Win hotkey to start voice input`n`n## System Requirements`n- Windows 10/11 (64-bit)`n- NVIDIA GPU (GTX 1060 or higher)`n- 8GB RAM (16GB+ recommended)`n- Stable internet connection (for model download)`n`n## Project Homepage`nhttps://github.com/007slm/a8-whisper`n`n## Bug Reports`nhttps://github.com/007slm/a8-whisper/issues`n`n---`nA8 Whisper - Open source AI voice assistant, free alternative to Wispr Flow"
        [System.IO.File]::WriteAllText("release/README.txt", $readmeContent, [System.Text.Encoding]::UTF8)
        
        # Zip
        Compress-Archive -Path "release/*" -DestinationPath "$releaseName.zip"
        
        # Log size
        Get-Item "$releaseName.zip" | Select-Object Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB,2)}}
      shell: powershell
      
    - name: Upload Release Asset
      uses: actions/upload-artifact@v4
      with:
        name: A8Whisper-${{ github.ref_name }}
        path: A8Whisper-${{ github.ref_name }}.zip
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: A8Whisper-${{ github.ref_name }}.zip
        name: A8 Whisper ${{ github.ref_name }}
        body: |
          ## ðŸŽ‰ A8 Whisper ${{ github.ref_name }} (Nuitka Build)
          
          **This release is built with Nuitka for improved stability and performance.**
          
          ### ðŸ“¥ Download Instructions
          1. Download `A8Whisper-${{ github.ref_name }}.zip`
          2. Extract to any directory
          3. Double-click `A8Whisper.exe` to launch
          4. First run will automatically download AI models
          
          ### ðŸ“‹ System Requirements
          - Windows 10/11 (64-bit)
          - NVIDIA GPU (GTX 1060 or higher)
          - 8GB RAM (16GB+ recommended)
          - 10GB+ available storage space
          
          ### ðŸ”— Project Homepage
          https://github.com/007slm/a8-whisper
          
          ---
          **Full Changelog**: https://github.com/007slm/a8-whisper/releases
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}