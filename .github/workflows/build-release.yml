name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install uv
      run: pip install uv
      
    - name: Install Python dependencies
      run: uv sync
      
    - name: Install frontend dependencies
      run: |
        cd gui_web
        npm install
        
    - name: Build frontend
      run: |
        cd gui_web
        npm run build
        
    - name: Build executable
      run: |
        # åˆ›å»ºå›¾æ ‡æ–‡ä»¶ (å¦‚æœä¸å­˜åœ¨)
        if (-not (Test-Path "src/assets/icon.ico")) {
          uv run python -c "from PIL import Image; img = Image.new('RGB', (256, 256), (99, 102, 241)); img.save('src/assets/icon.ico', format='ICO'); print('Fallback icon.ico created')"
        }
        
        # æ„å»º EXE
        .\build.ps1 -Clean
      shell: powershell
      
    - name: Create release package
      run: |
        $version = "${{ github.ref_name }}"
        $releaseName = "A8è½»è¯­-$version"
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path "release"
        
        # å¤åˆ¶æ„å»ºç»“æœ (æ’é™¤ models ç›®å½•)
        Copy-Item -Path "dist/A8è½»è¯­/A8è½»è¯­.exe" -Destination "release/"
        Copy-Item -Recurse -Path "dist/A8è½»è¯­/_internal" -Destination "release/"
        
        # åˆ é™¤ _internal ä¸­çš„ models ç›®å½• (å‡å°å‘å¸ƒåŒ…å¤§å°)
        $internalModels = "release/_internal/models"
        if (Test-Path $internalModels) {
          Remove-Item -Recurse -Force $internalModels
          Write-Host "Removed models from _internal directory"
        }
        
        # åˆ›å»ºä½¿ç”¨è¯´æ˜
        @"
        # A8è½»è¯­ $version ä½¿ç”¨è¯´æ˜
        
        ## ğŸš€ å¿«é€Ÿå¼€å§‹
        1. åŒå‡» A8è½»è¯­.exe å¯åŠ¨ç¨‹åº
        2. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½ AI æ¨¡å‹ (çº¦ 3GB)
        3. ä½¿ç”¨ Ctrl + Win å¿«æ·é”®å¼€å§‹è¯­éŸ³è¾“å…¥
        
        ## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
        - Windows 10/11 (64-bit)
        - NVIDIA GPU (GTX 1060 æˆ–æ›´é«˜)
        - 8GB RAM (æ¨è 16GB+)
        - ç¨³å®šçš„ç½‘ç»œè¿æ¥ (é¦–æ¬¡ä¸‹è½½æ¨¡å‹)
        
        ## ğŸ”— é¡¹ç›®ä¸»é¡µ
        https://github.com/007slm/a8-whisper
        
        ## ğŸ› é—®é¢˜åé¦ˆ
        https://github.com/007slm/a8-whisper/issues
        
        ---
        A8è½»è¯­ - å¼€æº AI è¯­éŸ³åŠ©æ‰‹ï¼ŒWispr Flow çš„å…è´¹æ›¿ä»£æ–¹æ¡ˆ
        "@ | Out-File -FilePath "release/ä½¿ç”¨è¯´æ˜.txt" -Encoding UTF8
        
        # å‹ç¼©å‘å¸ƒåŒ…
        Compress-Archive -Path "release/*" -DestinationPath "$releaseName.zip"
        
        # è¾“å‡ºæ–‡ä»¶ä¿¡æ¯
        Get-Item "$releaseName.zip" | Select-Object Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB,2)}}
      shell: powershell
      
    - name: Upload Release Asset
      uses: actions/upload-artifact@v4
      with:
        name: A8è½»è¯­-${{ github.ref_name }}
        path: A8è½»è¯­-${{ github.ref_name }}.zip
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: A8è½»è¯­-${{ github.ref_name }}.zip
        name: A8è½»è¯­ ${{ github.ref_name }}
        body: |
          ## ğŸ‰ A8è½»è¯­ ${{ github.ref_name }}
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          1. ä¸‹è½½ `A8è½»è¯­-${{ github.ref_name }}.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡» `A8è½»è¯­.exe` å¯åŠ¨
          4. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½ AI æ¨¡å‹
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 (64-bit)
          - NVIDIA GPU (GTX 1060 æˆ–æ›´é«˜)
          - 8GB RAM (æ¨è 16GB+)
          - 10GB+ å¯ç”¨å­˜å‚¨ç©ºé—´
          
          ### ğŸ”— é¡¹ç›®ä¸»é¡µ
          https://github.com/007slm/a8-whisper
          
          ---
          **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/007slm/a8-whisper/releases
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}