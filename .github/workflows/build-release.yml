name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release
  packages: write  # å¯é€‰ï¼Œå¦‚æœéœ€è¦å‘å¸ƒåŒ…
  actions: read    # è¯»å– Actions æƒé™

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'gui_web/package-lock.json'
        
    - name: Install uv
      run: pip install uv
      
    - name: Cache uv dependencies
      uses: actions/cache@v4
      with:
        path: |
          .venv
          ~/.cache/uv
          %LOCALAPPDATA%\uv\cache
        key: ${{ runner.os }}-uv-python${{ matrix.python-version || '3.11' }}-${{ hashFiles('uv.lock', 'pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-python${{ matrix.python-version || '3.11' }}-
          ${{ runner.os }}-uv-
      
    - name: Install Python dependencies
      run: |
        uv sync
        # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬çš„ PyInstaller
        uv pip install pyinstaller==6.11.0
      
    - name: Cache frontend dependencies
      uses: actions/cache@v4
      with:
        path: gui_web/node_modules
        key: ${{ runner.os }}-npm-${{ hashFiles('gui_web/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-
      
    - name: Install frontend dependencies
      run: |
        cd gui_web
        npm ci --prefer-offline
        
    - name: Build frontend
      run: |
        cd gui_web
        npm run build
        
    - name: Cache frontend build
      uses: actions/cache@v4
      with:
        path: gui_web/dist
        key: ${{ runner.os }}-frontend-${{ hashFiles('gui_web/src/**/*', 'gui_web/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-frontend-
        
    - name: Cache PyInstaller build
      uses: actions/cache@v4
      with:
        path: |
          build
          dist
        key: ${{ runner.os }}-pyinstaller-${{ hashFiles('src/**/*.py', 'a8qingyu.spec', 'pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pyinstaller-
    
    - name: Build executable
      run: |
        # æ€æ­»å¯èƒ½å ç”¨æ–‡ä»¶çš„è¿›ç¨‹
        Get-Process | Where-Object {$_.ProcessName -like "*A8*" -or $_.ProcessName -like "*python*"} | Stop-Process -Force -ErrorAction SilentlyContinue
        
        # ç­‰å¾…è¿›ç¨‹å®Œå…¨é€€å‡º
        Start-Sleep -Seconds 2
        
        # æ¸…ç†å¯èƒ½é”å®šçš„æ–‡ä»¶
        if (Test-Path "dist") {
          try {
            Remove-Item -Recurse -Force "dist" -ErrorAction Stop
          } catch {
            Write-Host "Warning: Could not remove dist directory, trying to continue..."
          }
        }
        
        # åˆ›å»ºå›¾æ ‡æ–‡ä»¶ (å¦‚æœä¸å­˜åœ¨)
        if (-not (Test-Path "src/assets/icon.ico")) {
          uv run python -c "from PIL import Image; img = Image.new('RGB', (256, 256), (99, 102, 241)); img.save('src/assets/icon.ico', format='ICO'); print('Fallback icon.ico created')"
        }
        
        # æ„å»º EXE (è·³è¿‡å‰ç«¯æ„å»ºï¼Œå› ä¸ºå·²ç»å•ç‹¬æ„å»ºäº†)
        .\build.ps1 -SkipFrontend -Clean
      shell: powershell
      
    - name: Create release package
      run: |
        $version = "${{ github.ref_name }}"
        $releaseName = "A8Whisper-$version"  # ä½¿ç”¨è‹±æ–‡åç§°
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path "release"
        
        # æ£€æŸ¥æ„å»ºç»“æœç›®å½•
        Write-Host "Checking build output directory..."
        Get-ChildItem -Path "dist" -Recurse | Select-Object FullName
        
        # ä½¿ç”¨é€šé…ç¬¦å¤åˆ¶æ–‡ä»¶ï¼Œé¿å…ä¸­æ–‡è·¯å¾„ç¼–ç é—®é¢˜
        $exeFiles = Get-ChildItem -Path "dist" -Filter "*.exe" -Recurse
        if ($exeFiles.Count -eq 0) {
          Write-Host "ERROR: No EXE file found in dist directory"
          exit 1
        }
        
        $exeFile = $exeFiles[0]
        $internalDir = Join-Path $exeFile.Directory.FullName "_internal"
        
        Write-Host "Found EXE: $($exeFile.FullName)"
        Write-Host "Internal dir: $internalDir"
        
        # å¤åˆ¶æ„å»ºç»“æœ
        Copy-Item -Path $exeFile.FullName -Destination "release/"
        if (Test-Path $internalDir) {
          Copy-Item -Recurse -Path $internalDir -Destination "release/"
        }
        
        # åˆ é™¤ _internal ä¸­çš„ models ç›®å½•å†…å®¹ (ä½†ä¿ç•™ç›®å½•)
        $internalModels = "release/_internal/models"
        if (Test-Path $internalModels) {
          Get-ChildItem -Path $internalModels -Recurse | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
          Write-Host "Cleared models content from _internal directory (keeping empty directory)"
        } else {
          New-Item -ItemType Directory -Force -Path $internalModels | Out-Null
          Write-Host "Created empty models directory in _internal"
        }
        
        # é‡å‘½å EXE æ–‡ä»¶ä¸ºè‹±æ–‡åç§° (é¿å…ä¸‹è½½æ—¶çš„ç¼–ç é—®é¢˜)
        $releaseExe = Get-ChildItem -Path "release" -Filter "*.exe"
        if ($releaseExe) {
          Rename-Item -Path $releaseExe.FullName -NewName "A8Whisper.exe"
          Write-Host "Renamed EXE to A8Whisper.exe"
        }
        
        # åˆ›å»ºä½¿ç”¨è¯´æ˜æ–‡ä»¶ (ä½¿ç”¨è‹±æ–‡å†…å®¹é¿å…ç¼–ç é—®é¢˜)
        $readmeContent = "# A8 Whisper $version - User Guide`n`n## Quick Start`n1. Double-click A8Whisper.exe to launch`n2. First run will download AI models (about 3GB)`n3. Use Ctrl + Win hotkey to start voice input`n`n## System Requirements`n- Windows 10/11 (64-bit)`n- NVIDIA GPU (GTX 1060 or higher)`n- 8GB RAM (16GB+ recommended)`n- Stable internet connection (for model download)`n`n## Project Homepage`nhttps://github.com/007slm/a8-whisper`n`n## Bug Reports`nhttps://github.com/007slm/a8-whisper/issues`n`n---`nA8 Whisper - Open source AI voice assistant, free alternative to Wispr Flow"
        [System.IO.File]::WriteAllText("release/README.txt", $readmeContent, [System.Text.Encoding]::UTF8)
        
        # å‹ç¼©å‘å¸ƒåŒ… (ä½¿ç”¨è‹±æ–‡æ–‡ä»¶å)
        Compress-Archive -Path "release/*" -DestinationPath "$releaseName.zip"
        
        # è¾“å‡ºæ–‡ä»¶ä¿¡æ¯
        Get-Item "$releaseName.zip" | Select-Object Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB,2)}}
      shell: powershell
      
    - name: Upload Release Asset
      uses: actions/upload-artifact@v4
      with:
        name: A8Whisper-${{ github.ref_name }}
        path: A8Whisper-${{ github.ref_name }}.zip
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: A8Whisper-${{ github.ref_name }}.zip
        name: A8 Whisper ${{ github.ref_name }}
        body: |
          ## ğŸ‰ A8 Whisper ${{ github.ref_name }}
          
          ### ğŸ“¥ Download Instructions
          1. Download `A8Whisper-${{ github.ref_name }}.zip`
          2. Extract to any directory
          3. Double-click `A8Whisper.exe` to launch
          4. First run will automatically download AI models
          
          ### ğŸ“‹ System Requirements
          - Windows 10/11 (64-bit)
          - NVIDIA GPU (GTX 1060 or higher)
          - 8GB RAM (16GB+ recommended)
          - 10GB+ available storage space
          
          ### ğŸ”— Project Homepage
          https://github.com/007slm/a8-whisper
          
          ---
          **Full Changelog**: https://github.com/007slm/a8-whisper/releases
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}